<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byggfl√∂de - Admin & Kund</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .progress-bar { transition: width 0.5s ease; }
        .modal-overlay { backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const API_URL = 'https://script.google.com/macros/s/AKfycbzA151Db9RytanxMcMYy_0EhMHRH3riPDLUZ2OkwIIexBGYjs3aMdiy6vxPGH2nRLs/exec';
        
        const api = {
            async get(path, params = {}) {
                const url = new URL(API_URL);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                const response = await fetch(url);
                return response.json();
            },
            
            async post(path, data = {}) {
                const formData = new URLSearchParams();
                formData.append('path', path);
                Object.keys(data).forEach(key => formData.append(key, data[key]));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });
                return response.json();
            }
        };
        
        // Modal Component
        function Modal({ isOpen, onClose, title, children }) {
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">{title}</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 text-3xl leading-none"
                            >
                                √ó
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        }
        
        // Main App
        function App() {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const savedSession = localStorage.getItem('byggflode_session');
                if (savedSession) {
                    setSession(JSON.parse(savedSession));
                }
                setLoading(false);
            }, []);
            
            const login = (sessionData) => {
                setSession(sessionData);
                localStorage.setItem('byggflode_session', JSON.stringify(sessionData));
            };
            
            const logout = () => {
                setSession(null);
                localStorage.removeItem('byggflode_session');
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-white text-2xl">Laddar...</div>
                    </div>
                );
            }
            
            if (!session) {
                return <LoginPage onLogin={login} />;
            }
            
            return <MainApp session={session} onLogout={logout} />;
        }
        
        // Login Page (samma som f√∂rut)
        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [otpSent, setOtpSent] = useState(false);
            const [otp, setOtp] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const requestOTP = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const result = await api.post('auth/request-otp', { email, projectId: '' });
                    
                    if (result.success) {
                        setOtpSent(true);
                    } else {
                        setError(result.error || 'Kunde inte skicka kod');
                    }
                } catch (err) {
                    setError('N√•got gick fel. F√∂rs√∂k igen.');
                }
                
                setLoading(false);
            };
            
            const verifyOTP = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const result = await api.post('auth/verify-otp', { 
                        email, 
                        code: otp, 
                        projectId: '' 
                    });
                    
                    if (result.success) {
                        onLogin({
                            email: result.email,
                            sessionToken: result.sessionToken
                        });
                    } else {
                        setError(result.error || 'Ogiltig kod');
                    }
                } catch (err) {
                    setError('N√•got gick fel. F√∂rs√∂k igen.');
                }
                
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">üèóÔ∏è Byggfl√∂de</h1>
                            <p className="text-gray-600">F√∂lj ditt byggprojekt</p>
                        </div>
                        
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        {!otpSent ? (
                            <form onSubmit={requestOTP}>
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-semibold mb-2">Email</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="din@email.com"
                                        required
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 rounded-lg hover:opacity-90 disabled:opacity-50 transition"
                                >
                                    {loading ? 'Skickar...' : 'Skicka inloggningskod'}
                                </button>
                            </form>
                        ) : (
                            <form onSubmit={verifyOTP}>
                                <div className="mb-4 text-center text-green-600">
                                    ‚úì Kod skickad till {email}
                                </div>
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-semibold mb-2">Ange 6-siffrig kod</label>
                                    <input
                                        type="text"
                                        value={otp}
                                        onChange={(e) => setOtp(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest"
                                        placeholder="123456"
                                        maxLength="6"
                                        required
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 rounded-lg hover:opacity-90 disabled:opacity-50 transition mb-3"
                                >
                                    {loading ? 'Verifierar...' : 'Logga in'}
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setOtpSent(false)}
                                    className="w-full text-gray-600 hover:text-gray-800"
                                >
                                    Skicka ny kod
                                </button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }
        
        // Create Project Modal
        function CreateProjectModal({ isOpen, onClose, onSuccess, session }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [steps, setSteps] = useState(['']);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const addStep = () => {
                setSteps([...steps, '']);
            };
            
            const removeStep = (index) => {
                setSteps(steps.filter((_, i) => i !== index));
            };
            
            const updateStep = (index, value) => {
                const newSteps = [...steps];
                newSteps[index] = value;
                setSteps(newSteps);
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                const validSteps = steps.filter(s => s.trim() !== '');
                
                if (validSteps.length === 0) {
                    setError('L√§gg till minst ett steg');
                    setLoading(false);
                    return;
                }
                
                try {
                    const result = await api.post('project/create', {
                        session: session.sessionToken,
                        name,
                        description,
                        steps: validSteps.join(',')
                    });
                    
                    if (result.success) {
                        onSuccess();
                        onClose();
                        setName('');
                        setDescription('');
                        setSteps(['']);
                    } else {
                        setError(result.error || 'Kunde inte skapa projekt');
                    }
                } catch (err) {
                    setError('N√•got gick fel');
                }
                
                setLoading(false);
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Skapa nytt projekt">
                    <form onSubmit={handleSubmit}>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 font-semibold mb-2">Projektnamn</label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="t.ex. Badrumsrenovering Andersson"
                                required
                            />
                        </div>
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 font-semibold mb-2">Beskrivning</label>
                            <textarea
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Kort beskrivning av projektet"
                                rows="3"
                            />
                        </div>
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 font-semibold mb-2">Steg i projektet</label>
                            {steps.map((step, index) => (
                                <div key={index} className="flex gap-2 mb-2">
                                    <input
                                        type="text"
                                        value={step}
                                        onChange={(e) => updateStep(index, e.target.value)}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder={`Steg ${index + 1}, t.ex. Rivning`}
                                    />
                                    {steps.length > 1 && (
                                        <button
                                            type="button"
                                            onClick={() => removeStep(index)}
                                            className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                                        >
                                            ‚úï
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button
                                type="button"
                                onClick={addStep}
                                className="mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            >
                                + L√§gg till steg
                            </button>
                        </div>
                        
                        <div className="flex gap-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                            >
                                Avbryt
                            </button>
                            <button
                                type="submit"
                                disabled={loading}
                                className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading ? 'Skapar...' : 'Skapa projekt'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }
        
        // Invite Member Modal
        function InviteMemberModal({ isOpen, onClose, project, session }) {
            const [email, setEmail] = useState('');
            const [notifyOnPost, setNotifyOnPost] = useState(true);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');
                
                try {
                    const result = await api.post('project/add-member', {
                        session: session.sessionToken,
                        projectId: project.project_id,
                        memberEmail: email,
                        role: 'customer',
                        notifyOnPost: notifyOnPost
                    });
                    
                    if (result.success) {
                        setSuccess('Medlem tillagd!');
                        setEmail('');
                        setTimeout(() => {
                            setSuccess('');
                            onClose();
                        }, 2000);
                    } else {
                        setError(result.error || 'Kunde inte l√§gga till medlem');
                    }
                } catch (err) {
                    setError('N√•got gick fel');
                }
                
                setLoading(false);
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Bjud in kund">
                    <form onSubmit={handleSubmit}>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        {success && (
                            <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                                {success}
                            </div>
                        )}
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 font-semibold mb-2">Email till kund</label>
                            <input
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="kund@example.com"
                                required
                            />
                            <p className="text-sm text-gray-500 mt-2">
                                OBS: Kontot m√•ste finnas i systemet f√∂rst. Kontakta admin f√∂r att skapa konto.
                            </p>
                        </div>
                        
                        <div className="mb-6">
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={notifyOnPost}
                                    onChange={(e) => setNotifyOnPost(e.target.checked)}
                                    className="w-5 h-5"
                                />
                                <span className="text-gray-700">Skicka notiser vid nya inl√§gg</span>
                            </label>
                        </div>
                        
                        <div className="flex gap-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                            >
                                Avbryt
                            </button>
                            <button
                                type="submit"
                                disabled={loading}
                                className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading ? 'Bjuder in...' : 'Bjud in'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }
        
        // Create Post Modal
        function CreatePostModal({ isOpen, onClose, step, projectId, session, onSuccess }) {
            const [text, setText] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const result = await api.post('post/create', {
                        session: session.sessionToken,
                        projectId: projectId,
                        stepId: step.step_id,
                        text: text,
                        imageFileIds: ''
                    });
                    
                    if (result.success) {
                        setText('');
                        onSuccess();
                        onClose();
                    } else {
                        setError(result.error || 'Kunde inte skapa inl√§gg');
                    }
                } catch (err) {
                    setError('N√•got gick fel');
                }
                
                setLoading(false);
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Nytt inl√§gg - ${step?.step_name}`}>
                    <form onSubmit={handleSubmit}>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        <div className="mb-4">
                            <label className="block text-gray-700 font-semibold mb-2">Vad h√§nder?</label>
                            <textarea
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Skriv en uppdatering..."
                                rows="5"
                                required
                            />
                        </div>
                        
                        <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                            <p className="text-sm text-blue-800">
                                üí° Tips: Bilduppladdning kommer i n√§sta version!
                            </p>
                        </div>
                        
                        <div className="flex gap-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                            >
                                Avbryt
                            </button>
                            <button
                                type="submit"
                                disabled={loading}
                                className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {loading ? 'Publicerar...' : 'Publicera'}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        }
        
        // Main App (project list)
        function MainApp({ session, onLogout }) {
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userRole, setUserRole] = useState('customer');
            const [showCreateProject, setShowCreateProject] = useState(false);
            
            useEffect(() => {
                loadProjects();
            }, []);
            
            const loadProjects = async () => {
                setLoading(true);
                try {
                    const result = await api.get('projects', { 
                        path: 'projects',
                        session: session.sessionToken 
                    });
                    
                    if (result.success) {
                        setProjects(result.projects);
                        if (result.projects.length > 0) {
                            setUserRole(result.projects[0].userRole);
                        }
                    }
                } catch (err) {
                    console.error('Error loading projects:', err);
                }
                setLoading(false);
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-gray-600 text-xl">Laddar projekt...</div>
                    </div>
                );
            }
            
            if (selectedProject) {
                return (
                    <ProjectView 
                        project={selectedProject}
                        session={session}
                        userRole={userRole}
                        onBack={() => {
                            setSelectedProject(null);
                            loadProjects();
                        }}
                        onLogout={onLogout}
                    />
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-800">üèóÔ∏è Byggfl√∂de</h1>
                            <div className="flex items-center gap-4">
                                <span className="text-gray-600">{session.email}</span>
                                {userRole === 'admin' && (
                                    <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        Admin
                                    </span>
                                )}
                                <button
                                    onClick={onLogout}
                                    className="text-red-600 hover:text-red-800"
                                >
                                    Logga ut
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">Mina projekt</h2>
                            {userRole === 'admin' && (
                                <button
                                    onClick={() => setShowCreateProject(true)}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold"
                                >
                                    + Skapa projekt
                                </button>
                            )}
                        </div>
                        
                        {projects.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">Du har inga projekt √§n</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {projects.map(project => (
                                    <ProjectCard
                                        key={project.project_id}
                                        project={project}
                                        onClick={() => setSelectedProject(project)}
                                    />
                                ))}
                            </div>
                        )}
                    </main>
                    
                    <CreateProjectModal
                        isOpen={showCreateProject}
                        onClose={() => setShowCreateProject(false)}
                        onSuccess={loadProjects}
                        session={session}
                    />
                </div>
            );
        }
        
        // Project Card
        function ProjectCard({ project, onClick }) {
            const percentage = project.completion_percentage || 0;
            
            return (
                <div
                    onClick={onClick}
                    className="bg-white rounded-lg shadow hover:shadow-xl transition cursor-pointer p-6"
                >
                    <h3 className="text-xl font-bold text-gray-800 mb-2">
                        {project.name}
                    </h3>
                    <p className="text-gray-600 mb-4">
                        {project.description}
                    </p>
                    
                    <div className="mb-3">
                        <div className="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Framsteg</span>
                            <span className="font-semibold">{percentage}%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-3">
                            <div
                                className="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-bar"
                                style={{ width: `${percentage}%` }}
                            />
                        </div>
                    </div>
                    
                    <div className="flex justify-between items-center text-sm">
                        <span className="text-gray-500">
                            {project.userRole === 'admin' ? 'üëë Admin' : 'üë§ Medlem'}
                        </span>
                        <span className="text-blue-600 font-semibold">Visa ‚Üí</span>
                    </div>
                </div>
            );
        }
        
        // Project View
        function ProjectView({ project, session, userRole, onBack, onLogout }) {
            const [steps, setSteps] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showInvite, setShowInvite] = useState(false);
            
            useEffect(() => {
                loadSteps();
            }, []);
            
            const loadSteps = async () => {
                setLoading(true);
                try {
                    const result = await api.get('project/steps', {
                        path: 'project/steps',
                        projectId: project.project_id,
                        session: session.sessionToken
                    });
                    
                    if (result.success) {
                        setSteps(result.steps);
                    }
                } catch (err) {
                    console.error('Error loading steps:', err);
                }
                setLoading(false);
            };
            
            const percentage = project.completion_percentage || 0;
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={onBack}
                                    className="text-blue-600 hover:text-blue-800 font-semibold"
                                >
                                    ‚Üê Tillbaka
                                </button>
                                <h1 className="text-2xl font-bold text-gray-800">{project.name}</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                {userRole === 'admin' && (
                                    <button
                                        onClick={() => setShowInvite(true)}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold"
                                    >
                                        üë• Bjud in kund
                                    </button>
                                )}
                                <button
                                    onClick={onLogout}
                                    className="text-red-600 hover:text-red-800"
                                >
                                    Logga ut
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <main className="max-w-4xl mx-auto px-4 py-8">
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold text-gray-800">Projektframsteg</h2>
                                <span className="text-3xl font-bold text-blue-600">{percentage}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded-full progress-bar"
                                    style={{ width: `${percentage}%` }}
                                />
                            </div>
                            <p className="text-gray-600 mt-2">{project.description}</p>
                        </div>
                        
                        {loading ? (
                            <div className="text-center py-8 text-gray-600">Laddar steg...</div>
                        ) : steps.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600">Inga steg har lagts till √§n</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {steps.map((step, index) => (
                                    <StepCard
                                        key={step.step_id}
                                        step={step}
                                        index={index}
                                        projectId={project.project_id}
                                        session={session}
                                        userRole={userRole}
                                        onUpdate={loadSteps}
                                    />
                                ))}
                            </div>
                        )}
                    </main>
                    
                    <InviteMemberModal
                        isOpen={showInvite}
                        onClose={() => setShowInvite(false)}
                        project={project}
                        session={session}
                    />
                </div>
            );
        }
        
        // Step Card
        function StepCard({ step, index, projectId, session, userRole, onUpdate }) {
            const [expanded, setExpanded] = useState(false);
            const [posts, setPosts] = useState([]);
            const [loadingPosts, setLoadingPosts] = useState(false);
            const [showCreatePost, setShowCreatePost] = useState(false);
            const [completingStep, setCompletingStep] = useState(false);
            
            const isCompleted = step.status === 'completed';
            
            const loadPosts = async () => {
                if (posts.length > 0) return;
                
                setLoadingPosts(true);
                try {
                    const result = await api.get('step/posts', {
                        path: 'step/posts',
                        stepId: step.step_id,
                        session: session.sessionToken
                    });
                    
                    if (result.success) {
                        setPosts(result.posts);
                    }
                } catch (err) {
                    console.error('Error loading posts:', err);
                }
                setLoadingPosts(false);
            };
            
            const handleExpand = () => {
                if (!expanded) {
                    loadPosts();
                }
                setExpanded(!expanded);
            };
            
            const handleCompleteStep = async () => {
                if (!confirm(`Markera "${step.step_name}" som klart?`)) return;
                
                setCompletingStep(true);
                try {
                    const result = await api.post('step/complete', {
                        session: session.sessionToken,
                        stepId: step.step_id
                    });
                    
                    if (result.success) {
                        onUpdate();
                    } else {
                        alert('Kunde inte markera steg som klart: ' + result.error);
                    }
                } catch (err) {
                    alert('N√•got gick fel');
                }
                setCompletingStep(false);
            };
            
            const handlePostCreated = () => {
                setPosts([]);
                loadPosts();
            };
            
            return (
                <div className="bg-white rounded-lg shadow overflow-hidden">
                    <div className="p-6">
                        <div className="flex items-center gap-4">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl flex-shrink-0 ${
                                isCompleted ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600'
                            }`}>
                                {isCompleted ? '‚úì' : index + 1}
                            </div>
                            <div className="flex-1">
                                <h3 className="text-lg font-bold text-gray-800">{step.step_name}</h3>
                                <p className="text-sm text-gray-500">
                                    {isCompleted ? `Klart ${new Date(step.completed_at).toLocaleDateString('sv-SE')}` : 'P√•g√•ende'}
                                </p>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {userRole === 'admin' && !isCompleted && (
                                    <button
                                        onClick={handleCompleteStep}
                                        disabled={completingStep}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold disabled:opacity-50"
                                    >
                                        {completingStep ? '...' : '‚úì Markera klar'}
                                    </button>
                                )}
                                
                                {userRole === 'admin' && (
                                    <button
                                        onClick={() => setShowCreatePost(true)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold"
                                    >
                                        + L√§gg till
                                    </button>
                                )}
                                
                                <button
                                    onClick={handleExpand}
                                    className="text-gray-400 hover:text-gray-600 text-xl"
                                >
                                    {expanded ? '‚ñº' : '‚ñ∂'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {expanded && (
                        <div className="border-t bg-gray-50 p-6">
                            {loadingPosts ? (
                                <div className="text-center text-gray-600">Laddar inl√§gg...</div>
                            ) : posts.length === 0 ? (
                                <div className="text-center text-gray-600">
                                    {userRole === 'admin' 
                                        ? 'Inga uppdateringar √§n. Klicka "+ L√§gg till" f√∂r att skapa f√∂rsta inl√§gget!'
                                        : 'Inga uppdateringar f√∂r detta steg √§n'}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {posts.map(post => (
                                        <div key={post.post_id} className="bg-white rounded-lg p-4 shadow-sm">
                                            <div className="flex items-start gap-3 mb-3">
                                                <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                    {post.author_email[0].toUpperCase()}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="font-semibold text-gray-800">{post.author_email}</div>
                                                    <div className="text-sm text-gray-500">
                                                        {new Date(post.created_at).toLocaleDateString('sv-SE')}
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-gray-800 whitespace-pre-wrap">{post.text}</p>
                                            {post.images && post.images.length > 0 && (
                                                <div className="grid grid-cols-2 gap-2 mt-3">
                                                    {post.images.map((img, i) => (
                                                        <img
                                                            key={i}
                                                            src={img.thumbnailUrl}
                                                            alt="Bild"
                                                            className="rounded-lg w-full h-32 object-cover cursor-pointer hover:opacity-90 transition"
                                                            onClick={() => window.open(img.fullUrl, '_blank')}
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    <CreatePostModal
                        isOpen={showCreatePost}
                        onClose={() => setShowCreatePost(false)}
                        step={step}
                        projectId={projectId}
                        session={session}
                        onSuccess={handlePostCreated}
                    />
                </div>
            );
        }
        
        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
