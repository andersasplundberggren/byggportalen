<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byggfl√∂de</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbzA151Db9RytanxMcMYy_0EhMHRH3riPDLUZ2OkwIIexBGYjs3aMdiy6vxPGH2nRLs/exec';
        
        // API Helper
        const api = {
            async get(path, params = {}) {
                const url = new URL(API_URL);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                const response = await fetch(url);
                return response.json();
            },
            
            async post(path, data = {}) {
                const formData = new URLSearchParams();
                formData.append('path', path);
                Object.keys(data).forEach(key => formData.append(key, data[key]));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow'
                });
                return response.json();
            }
        };
        
        // Main App Component
        function App() {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const savedSession = localStorage.getItem('byggflode_session');
                if (savedSession) {
                    setSession(JSON.parse(savedSession));
                }
                setLoading(false);
            }, []);
            
            const login = (sessionData) => {
                setSession(sessionData);
                localStorage.setItem('byggflode_session', JSON.stringify(sessionData));
            };
            
            const logout = () => {
                setSession(null);
                localStorage.removeItem('byggflode_session');
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-white text-2xl">Laddar...</div>
                    </div>
                );
            }
            
            if (!session) {
                return <LoginPage onLogin={login} />;
            }
            
            return <MainApp session={session} onLogout={logout} />;
        }
        
        // Login Page Component
        function LoginPage({ onLogin }) {
            const [email, setEmail] = useState('');
            const [otpSent, setOtpSent] = useState(false);
            const [otp, setOtp] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const requestOTP = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const result = await api.post('auth/request-otp', { email, projectId: '' });
                    
                    if (result.success) {
                        setOtpSent(true);
                    } else {
                        setError(result.error || 'Kunde inte skicka kod');
                    }
                } catch (err) {
                    setError('N√•got gick fel. F√∂rs√∂k igen.');
                }
                
                setLoading(false);
            };
            
            const verifyOTP = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    const result = await api.post('auth/verify-otp', { 
                        email, 
                        code: otp, 
                        projectId: '' 
                    });
                    
                    if (result.success) {
                        onLogin({
                            email: result.email,
                            sessionToken: result.sessionToken
                        });
                    } else {
                        setError(result.error || 'Ogiltig kod');
                    }
                } catch (err) {
                    setError('N√•got gick fel. F√∂rs√∂k igen.');
                }
                
                setLoading(false);
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">üèóÔ∏è Byggfl√∂de</h1>
                            <p className="text-gray-600">F√∂lj ditt byggprojekt</p>
                        </div>
                        
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        {!otpSent ? (
                            <form onSubmit={requestOTP}>
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-semibold mb-2">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="din@email.com"
                                        required
                                    />
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 rounded-lg hover:opacity-90 disabled:opacity-50 transition"
                                >
                                    {loading ? 'Skickar...' : 'Skicka inloggningskod'}
                                </button>
                            </form>
                        ) : (
                            <form onSubmit={verifyOTP}>
                                <div className="mb-4 text-center text-green-600">
                                    ‚úì Kod skickad till {email}
                                </div>
                                
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-semibold mb-2">
                                        Ange 6-siffrig kod
                                    </label>
                                    <input
                                        type="text"
                                        value={otp}
                                        onChange={(e) => setOtp(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest"
                                        placeholder="123456"
                                        maxLength="6"
                                        required
                                    />
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3 rounded-lg hover:opacity-90 disabled:opacity-50 transition mb-3"
                                >
                                    {loading ? 'Verifierar...' : 'Logga in'}
                                </button>
                                
                                <button
                                    type="button"
                                    onClick={() => setOtpSent(false)}
                                    className="w-full text-gray-600 hover:text-gray-800"
                                >
                                    Skicka ny kod
                                </button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }
        
        // Main App Component (after login)
        function MainApp({ session, onLogout }) {
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                loadProjects();
            }, []);
            
            const loadProjects = async () => {
                setLoading(true);
                try {
                    const result = await api.get('projects', { 
                        path: 'projects',
                        session: session.sessionToken 
                    });
                    
                    if (result.success) {
                        setProjects(result.projects);
                    }
                } catch (err) {
                    console.error('Error loading projects:', err);
                }
                setLoading(false);
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-gray-600 text-xl">Laddar projekt...</div>
                    </div>
                );
            }
            
            if (selectedProject) {
                return (
                    <ProjectView 
                        project={selectedProject}
                        session={session}
                        onBack={() => setSelectedProject(null)}
                        onLogout={onLogout}
                    />
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-800">üèóÔ∏è Byggfl√∂de</h1>
                            <div className="flex items-center gap-4">
                                <span className="text-gray-600">{session.email}</span>
                                <button
                                    onClick={onLogout}
                                    className="text-red-600 hover:text-red-800"
                                >
                                    Logga ut
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <h2 className="text-3xl font-bold text-gray-800 mb-6">Mina projekt</h2>
                        
                        {projects.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center">
                                <p className="text-gray-600 mb-4">Du har inga projekt √§n</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {projects.map(project => (
                                    <div
                                        key={project.project_id}
                                        onClick={() => setSelectedProject(project)}
                                        className="bg-white rounded-lg shadow hover:shadow-xl transition cursor-pointer p-6"
                                    >
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">
                                            {project.name}
                                        </h3>
                                        <p className="text-gray-600 mb-4">
                                            {project.description}
                                        </p>
                                        <div className="flex justify-between items-center text-sm text-gray-500">
                                            <span>{project.userRole === 'admin' ? 'üëë Admin' : 'üë§ Medlem'}</span>
                                            <span>‚Üí</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        
        // Project View Component
        function ProjectView({ project, session, onBack, onLogout }) {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newPostText, setNewPostText] = useState('');
            const [posting, setPosting] = useState(false);
            
            useEffect(() => {
                loadPosts();
            }, []);
            
            const loadPosts = async () => {
                try {
                    const result = await api.get('posts', {
                        path: 'posts',
                        projectId: project.project_id,
                        session: session.sessionToken
                    });
                    
                    if (result.success) {
                        setPosts(result.posts);
                    }
                } catch (err) {
                    console.error('Error loading posts:', err);
                }
                setLoading(false);
            };
            
            const createPost = async (e) => {
                e.preventDefault();
                if (!newPostText.trim()) return;
                
                setPosting(true);
                try {
                    const result = await api.post('post/create', {
                        session: session.sessionToken,
                        projectId: project.project_id,
                        text: newPostText,
                        imageFileIds: ''
                    });
                    
                    if (result.success) {
                        setNewPostText('');
                        loadPosts();
                    }
                } catch (err) {
                    console.error('Error creating post:', err);
                }
                setPosting(false);
            };
            
            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={onBack}
                                    className="text-blue-600 hover:text-blue-800"
                                >
                                    ‚Üê Tillbaka
                                </button>
                                <h1 className="text-2xl font-bold text-gray-800">{project.name}</h1>
                            </div>
                            <button
                                onClick={onLogout}
                                className="text-red-600 hover:text-red-800"
                            >
                                Logga ut
                            </button>
                        </div>
                    </header>
                    
                    <main className="max-w-4xl mx-auto px-4 py-8">
                        {/* Create Post */}
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <form onSubmit={createPost}>
                                <textarea
                                    value={newPostText}
                                    onChange={(e) => setNewPostText(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg p-4 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Vad h√§nder p√• projektet?"
                                    rows="3"
                                />
                                <button
                                    type="submit"
                                    disabled={posting || !newPostText.trim()}
                                    className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition"
                                >
                                    {posting ? 'Publicerar...' : 'Publicera'}
                                </button>
                            </form>
                        </div>
                        
                        {/* Posts Feed */}
                        {loading ? (
                            <div className="text-center py-8 text-gray-600">Laddar inl√§gg...</div>
                        ) : posts.length === 0 ? (
                            <div className="bg-white rounded-lg shadow p-8 text-center text-gray-600">
                                Inga inl√§gg √§n. Skapa det f√∂rsta!
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {posts.map(post => (
                                    <PostCard
                                        key={post.post_id}
                                        post={post}
                                        session={session}
                                        onUpdate={loadPosts}
                                    />
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        
        // Post Card Component
        function PostCard({ post, session, onUpdate }) {
            const [showComments, setShowComments] = useState(false);
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [liked, setLiked] = useState(false);
            const [commenting, setCommenting] = useState(false);
            
            const toggleLike = async () => {
                try {
                    if (liked) {
                        await api.post('post/reaction/remove', {
                            session: session.sessionToken,
                            postId: post.post_id
                        });
                    } else {
                        await api.post('post/reaction/add', {
                            session: session.sessionToken,
                            postId: post.post_id,
                            type: 'like'
                        });
                    }
                    setLiked(!liked);
                    onUpdate();
                } catch (err) {
                    console.error('Error toggling like:', err);
                }
            };
            
            const loadComments = async () => {
                try {
                    const result = await api.get('post/comments', {
                        path: 'post/comments',
                        postId: post.post_id
                    });
                    
                    if (result.success) {
                        setComments(result.comments);
                    }
                } catch (err) {
                    console.error('Error loading comments:', err);
                }
            };
            
            const addComment = async (e) => {
                e.preventDefault();
                if (!newComment.trim()) return;
                
                setCommenting(true);
                try {
                    const result = await api.post('post/comment/add', {
                        session: session.sessionToken,
                        postId: post.post_id,
                        text: newComment
                    });
                    
                    if (result.success) {
                        setNewComment('');
                        loadComments();
                    }
                } catch (err) {
                    console.error('Error adding comment:', err);
                }
                setCommenting(false);
            };
            
            const toggleComments = () => {
                if (!showComments) {
                    loadComments();
                }
                setShowComments(!showComments);
            };
            
            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-start gap-4 mb-4">
                        <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                            {post.author_email[0].toUpperCase()}
                        </div>
                        <div className="flex-1">
                            <div className="font-semibold text-gray-800">{post.author_email}</div>
                            <div className="text-sm text-gray-500">
                                {new Date(post.created_at).toLocaleDateString('sv-SE')}
                            </div>
                        </div>
                    </div>
                    
                    <p className="text-gray-800 mb-4 whitespace-pre-wrap">{post.text}</p>
                    
                    {post.images && post.images.length > 0 && (
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            {post.images.map((img, i) => (
                                <img
                                    key={i}
                                    src={img.thumbnailUrl}
                                    alt="Post bild"
                                    className="rounded-lg w-full h-48 object-cover"
                                />
                            ))}
                        </div>
                    )}
                    
                    <div className="border-t pt-4 flex gap-4">
                        <button
                            onClick={toggleLike}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                                liked ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            {liked ? '‚ù§Ô∏è' : 'ü§ç'} Gilla
                        </button>
                        <button
                            onClick={toggleComments}
                            className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition"
                        >
                            üí¨ Kommentera
                        </button>
                    </div>
                    
                    {showComments && (
                        <div className="mt-4 border-t pt-4">
                            <form onSubmit={addComment} className="mb-4">
                                <input
                                    type="text"
                                    value={newComment}
                                    onChange={(e) => setNewComment(e.target.value)}
                                    placeholder="Skriv en kommentar..."
                                    className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </form>
                            
                            {comments.length === 0 ? (
                                <p className="text-gray-500 text-sm">Inga kommentarer √§n</p>
                            ) : (
                                <div className="space-y-3">
                                    {comments.map(comment => (
                                        <div key={comment.commentId} className="bg-gray-50 rounded-lg p-3">
                                            <div className="font-semibold text-sm text-gray-800">
                                                {comment.userEmail}
                                            </div>
                                            <p className="text-gray-700">{comment.text}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }
        
        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
